<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Activity</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-5xl mx-auto bg-white rounded-xl shadow-lg p-6">
        <div class="flex items-center justify-between mb-4 border-b pb-4">
            <h3 class="text-xl font-semibold text-gray-800">Recent Login Activity</h3>
            <div class="flex items-center space-x-3">
                <span id="activeUsersCount" class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                    2 Active Users
                </span>
                <button onclick="clearLoginHistory()" class="text-sm text-red-500 hover:text-red-700 font-medium">
                    Clear History
                </button>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full border-collapse">
                <thead>
                    <tr class="text-left text-gray-600 bg-gray-200 text-sm">
                        <th class="p-3">Username</th>
                        <th class="p-3">Role</th>
                        <th class="p-3">Login Time</th>
                        <th class="p-3">Status</th>
                        <th class="p-3">Location</th>
                    </tr>
                </thead>
                <tbody id="loginActivityTable" class="text-sm text-gray-700">
                    <!-- Login activity will be populated here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        class LoginTracker {
            constructor() {
                this.loginHistory = JSON.parse(localStorage.getItem('loginHistory')) || [];
                this.activeUsers = new Set();
                this.initializeTracker();
            }

            initializeTracker() {
                this.updateActiveUsersCount();
                this.displayLoginHistory();
                this.startActivityMonitoring();
            }

            async recordLogin(username, role) {
                const timestamp = new Date().toISOString();
                const location = await this.getLocation();
                
                const loginRecord = {
                    username, role, timestamp, status: 'Active', location,
                    sessionId: Math.random().toString(36).substr(2, 9)
                };
                
                this.loginHistory.unshift(loginRecord);
                this.activeUsers.add(loginRecord.sessionId);
                if (this.loginHistory.length > 50) this.loginHistory.pop();
                this.saveHistory();
                this.updateDisplay();
            }

            async getLocation() {
                try {
                    const response = await fetch('https://ipapi.co/json/');
                    const data = await response.json();
                    return `${data.city}, ${data.country_code}`;
                } catch (error) {
                    return 'Unknown Location';
                }
            }

            updateActiveUsersCount() {
                document.getElementById('activeUsersCount').textContent = 
                    `${this.activeUsers.size} Active User${this.activeUsers.size !== 1 ? 's' : ''}`;
            }

            displayLoginHistory() {
                const tableBody = document.getElementById('loginActivityTable');
                if (!tableBody) return;
                
                tableBody.innerHTML = this.loginHistory.map(record => `
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="p-3 flex items-center">
                            <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-gray-600 font-semibold mr-3">
                                ${record.username.charAt(0).toUpperCase()}
                            </div>
                            ${record.username}
                        </td>
                        <td class="p-3">
                            <span class="px-2 py-1 rounded-full text-xs font-medium text-white bg-${record.role === 'admin' ? 'purple' : 'blue'}-500">
                                ${record.role}
                            </span>
                        </td>
                        <td class="p-3">${this.formatTimestamp(record.timestamp)}</td>
                        <td class="p-3">
                            <span class="flex items-center">
                                <span class="w-2 h-2 rounded-full ${this.isActive(record.sessionId) ? 'bg-green-400' : 'bg-gray-400'} mr-2"></span>
                                ${this.isActive(record.sessionId) ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td class="p-3">${record.location}</td>
                    </tr>
                `).join('');
            }

            formatTimestamp(timestamp) {
                const date = new Date(timestamp);
                const now = new Date();
                const diffMinutes = Math.floor((now - date) / 60000);
                
                if (diffMinutes < 1) return 'Just now';
                if (diffMinutes < 60) return `${diffMinutes}m ago`;
                if (diffMinutes < 1440) return `${Math.floor(diffMinutes / 60)}h ago`;
                return date.toLocaleDateString();
            }

            isActive(sessionId) {
                return this.activeUsers.has(sessionId);
            }

            startActivityMonitoring() {
                setInterval(() => {
                    const thirtyMinutesAgo = new Date(Date.now() - 30 * 60 * 1000);
                    this.loginHistory.forEach(record => {
                        if (new Date(record.timestamp) < thirtyMinutesAgo) {
                            this.activeUsers.delete(record.sessionId);
                        }
                    });
                    this.updateDisplay();
                }, 60000);
            }

            updateDisplay() {
                this.updateActiveUsersCount();
                this.displayLoginHistory();
                this.saveHistory();
            }

            saveHistory() {
                localStorage.setItem('loginHistory', JSON.stringify(this.loginHistory));
            }

            clearHistory() {
                this.loginHistory = [];
                this.activeUsers.clear();
                this.updateDisplay();
            }
        }

        const loginTracker = new LoginTracker();

        function checkAuth() {
            const currentUser = sessionStorage.getItem('currentUser');
            if (!currentUser || currentUser !== 'Ghost') {
                window.location.href = 'login.html';
            } else {
                loginTracker.recordLogin(currentUser, 'admin');
            }
        }

        function clearLoginHistory() {
            if (confirm('Are you sure you want to clear the login history?')) {
                loginTracker.clearHistory();
            }
        }
    </script>
</body>
</html>
